#!/bin/bash

project=mynamespace

# Check that minishift is installed
minishift=$(which minishift)
if [ -z "$minishift" ];
then
	echo "Minishift not found, see https://github.com/minishift/minishift#getting-started for installation instructions"
	exit 1
fi

# Ensure minishift is running
is_running=$(minishift status | grep Minishift | awk '{print $2}')
if [ "$is_running" != "Running" ];
then
	echo "You must start minishift"
	exit 1
fi

# Make sure path to the oc binary is on our PATH
eval $(minishift oc-env)

# Login as admin
$(oc login -u system:admin >/dev/null)

res=$(oc describe scc anyuid | grep Users | awk '{print $2}' | grep miq-anyuid)
if [ -z "$res" ];
then
	echo "Creating SCC miq-anyuid..."
	$(oc adm policy add-scc-to-user anyuid system:serviceaccount:$project:miq-anyuid >/dev/null)
fi

res=$(oc describe scc anyuid | grep Users | awk '{print $2}' | grep miq-orchestrator)
if [ -z "$res" ];
then
	echo "Creating SCC miq-orchestrator..."
	$(oc adm policy add-scc-to-user anyuid system:serviceaccount:$project:miq-orchestrator >/dev/null)
fi

res=$(oc get scc miq-sysadmin 2>/dev/null)
if [ $? -ne 0 ];
then
	echo "Creating SCC miq-sysadmin"
	$(oc create -f templates/miq-scc-sysadmin.yaml >/dev/null)
fi

res=$(oc describe scc miq-sysadmin | grep Users | awk '{print $2}' | grep miq-httpd) 
if [ -z "$res" ];
then
	echo "Creating SCC miq-httpd..."
	$(oc adm policy add-scc-to-user miq-sysadmin system:serviceaccount:$project:miq-httpd >/dev/null)
fi

res=$(oc get template manageiq 2>/dev/null)
if [ $? -ne 0 ];
then
	echo "Creating manageiq template..."
	$(oc create -f templates/miq-template.yaml >/dev/null)
fi

res=$(oc get all -l app=manageiq 2>&1 >/dev/null)
if [ "$res" = "No resources found." ];
then
	echo "Creating ManageIQ app..."
	res=$(oc new-app --template=manageiq)
fi
